var clippy={};clippy.Agent=function(t,i,e){this.path=t,this._queue=new clippy.Queue($.proxy(this._onQueueEmpty,this)),this._el=$('<div class="clippy"></div>').hide(),$(document.body).append(this._el),this._animator=new clippy.Animator(this._el,t,i,e),this._balloon=new clippy.Balloon(this._el),this._setupEvents()},clippy.Agent.prototype={gestureAt:function(t,i){var e=this._getDirection(t,i),o="Gesture"+e,n="Look"+e,s=this.hasAnimation(o)?o:n;return this.play(s)},hide:function(t,i){this._hidden=!0;var e=this._el;return this.stop(),t?(this._el.hide(),this.stop(),this.pause(),void(i&&i())):void this._addToQueue(function(t){this._animator.showAnimation("Hide",$.proxy(function(o,n){n===clippy.Animator.States.EXITED&&(e.hide(),this.pause(),i&&i(),t())},this))},this)},moveTo:function(t,i,e){var o=this._getDirection(t,i),n="Move"+o;void 0===e&&(e=1e3),this._addToQueue(function(o){if(0===e)return this._el.css({top:i,left:t}),this.reposition(),void o();if(!this.hasAnimation(n))return void this._el.animate({top:i,left:t},e,o);var s=$.proxy(function(n,s){s===clippy.Animator.States.EXITED&&o(),s===clippy.Animator.States.WAITING&&this._el.animate({top:i,left:t},e,$.proxy(function(){this._animator.exitAnimation()},this))},this);this._animator.showAnimation(n,s)},this)},play:function(t,i,e){return this.hasAnimation(t)?(void 0===i&&(i=5e3),this._addToQueue(function(o){var n=!1,s=function(t,i){i===clippy.Animator.States.EXITED&&(n=!0,e&&e(),o())};i&&window.setTimeout($.proxy(function(){n||this._animator.exitAnimation()},this),i),this._animator.showAnimation(t,s)},this),!0):!1},show:function(t){if(this._hidden=!1,t)return this._el.show(),this.resume(),void this._onQueueEmpty();if("auto"===this._el.css("top")||"auto"===!this._el.css("left")){var i=.8*$(window).width(),e=.8*($(window).height()+$(document).scrollTop());this._el.css({top:e,left:i})}return this.resume(),this.play("Show")},speak:function(t,i){this._addToQueue(function(e){this._balloon.speak(e,t,i)},this)},ask:function(t,i,e){this._addToQueue(function(o){this._balloon.ask(o,t,i,e)},this)},closeBalloon:function(){this._balloon.close()},delay:function(t){t=t||250,this._addToQueue(function(i){window.setTimeout(i,t)},this)},stopCurrent:function(){this._animator.exitAnimation(),this._balloon.close()},stop:function(){this._queue.clear(),this._animator.exitAnimation(),this._balloon.close()},hasAnimation:function(t){return this._animator.hasAnimation(t)},animations:function(){return this._animator.animations()},animate:function(){var t=this.animations(),i=t[Math.floor(Math.random()*t.length)];return 0===i.indexOf("Idle")||"Show"==i||"Hide"==i?this.animate():this.play(i)},_getDirection:function(t,i){var e=this._el.offset(),o=this._el.height(),n=this._el.width(),s=e.left+n/2,a=e.top+o/2,h=a-i,r=s-t,l=Math.round(180*Math.atan2(h,r)/Math.PI);return l>=-45&&45>l?"Right":l>=45&&135>l?"Up":l>=135&&180>=l||l>=-180&&-135>l?"Left":l>=-135&&-45>l?"Down":"Top"},_onQueueEmpty:function(){if(!this._hidden&&!this._isIdleAnimation()){var t=this._getIdleAnimation();this._idleDfd=$.Deferred(),this._animator.showAnimation(t,$.proxy(this._onIdleComplete,this))}},_onIdleComplete:function(t,i){i===clippy.Animator.States.EXITED&&(this._idleDfd.resolve(),this._queue.next())},_isIdleAnimation:function(){var t=this._animator.currentAnimationName;return t&&0==t.indexOf("Idle")&&this._idleDfd&&"pending"===this._idleDfd.state()},_getIdleAnimation:function(){for(var t=this.animations(),i=[],e=0;e<t.length;e++){var o=t[e];0===o.indexOf("Idle")&&i.push(o)}var n=Math.floor(Math.random()*i.length);return i[n]},_setupEvents:function(){$(window).on("resize",$.proxy(this.reposition,this)),this._el.on("mousedown",$.proxy(this._onMouseDown,this)),this._el.on("dblclick",$.proxy(this._onDoubleClick,this))},_onDoubleClick:function(){this.play("ClickedOn")||this.animate()},reposition:function(){if(this._el.is(":visible")){var t=this._el.offset(),i=this._el.outerHeight(),e=this._el.outerWidth(),o=$(window).width(),n=$(window).height(),s=$(window).scrollTop(),a=$(window).scrollLeft(),h=t.top-s,r=t.left-a,l=5;0>h-l?h=l:h+i+l>n&&(h=n-i-l),0>r-l?r=l:r+e+l>o&&(r=o-e-l),this._el.css({left:r,top:h}),this._balloon.reposition()}},_onMouseDown:function(t){t.preventDefault(),this._startDrag(t)},_startDrag:function(t){this.pause(),this._balloon.hide(),this._offset=this._calculateClickOffset(t),this._moveHandle=$.proxy(this._dragMove,this),this._upHandle=$.proxy(this._finishDrag,this),$(window).on("mousemove",this._moveHandle),$(window).on("mouseup",this._upHandle),this._dragUpdateLoop=window.setTimeout($.proxy(this._updateLocation,this),10)},_calculateClickOffset:function(t){var i=t.pageX,e=t.pageY,o=this._el.offset();return{top:e-o.top,left:i-o.left}},_updateLocation:function(){this._el.css({top:this._targetY,left:this._targetX}),this._dragUpdateLoop=window.setTimeout($.proxy(this._updateLocation,this),10)},_dragMove:function(t){t.preventDefault();var i=t.clientX-this._offset.left,e=t.clientY-this._offset.top;this._targetX=i,this._targetY=e},_finishDrag:function(){window.clearTimeout(this._dragUpdateLoop),$(window).off("mousemove",this._moveHandle),$(window).off("mouseup",this._upHandle),this._balloon.show(),this.reposition(),this.resume()},_addToQueue:function(t,i){return i&&(t=$.proxy(t,i)),this._isIdleAnimation()?(this._idleDfd.done($.proxy(function(){this._queue.queue(t)},this)),void this._animator.exitAnimation()):void this._queue.queue(t)},pause:function(){this._animator.pause(),this._balloon.pause()},resume:function(){this._animator.resume(),this._balloon.resume()}},clippy.Animator=function(t,i,e,o){this._el=t,this._data=e,this._path=i,this._currentFrameIndex=0,this._currentFrame=void 0,this._exiting=!1,this._currentAnimation=void 0,this._endCallback=void 0,this._started=!1,this._sounds={},this.currentAnimationName=void 0,this.preloadSounds(o),this._overlays=[this._el];var n=this._el;this._setupElement(this._el);for(var s=1;s<this._data.overlayCount;s++){var a=this._setupElement($("<div></div>"));n.append(a),this._overlays.push(a),n=a}},clippy.Animator.prototype={_setupElement:function(t){var i=this._data.framesize;return t.css("display","none"),t.css({width:i[0],height:i[1]}),t.css("background","url('"+this._path+"/map.png') no-repeat"),t},animations:function(){var t=[],i=this._data.animations;for(var e in i)t.push(e);return t},preloadSounds:function(t){for(var i=0;i<this._data.sounds.length;i++){var e=this._data.sounds[i],o=t[e];o&&(this._sounds[e]=new Audio(o))}},hasAnimation:function(t){return!!this._data.animations[t]},exitAnimation:function(){this._exiting=!0},showAnimation:function(t,i){return this._exiting=!1,this.hasAnimation(t)?(this._currentAnimation=this._data.animations[t],this.currentAnimationName=t,this._started||(this._step(),this._started=!0),this._currentFrameIndex=0,this._currentFrame=void 0,this._endCallback=i,!0):!1},_draw:function(){var t=[];this._currentFrame&&(t=this._currentFrame.images||[]);for(var i=0;i<this._overlays.length;i++)if(i<t.length){var e=t[i],o=-e[0]+"px "+-e[1]+"px";this._overlays[i].css({"background-position":o,display:"block"})}else this._overlays[i].css("display","none")},_getNextAnimationFrame:function(){if(!this._currentAnimation)return void 0;if(!this._currentFrame)return 0;var t=this._currentFrame,i=this._currentFrame.branching;if(this._exiting&&void 0!==t.exitBranch)return t.exitBranch;if(i)for(var e=100*Math.random(),o=0;o<i.branches.length;o++){var n=i.branches[o];if(e<=n.weight)return n.frameIndex;e-=n.weight}return this._currentFrameIndex+1},_playSound:function(){var t=this._currentFrame.sound;if(t){var i=this._sounds[t];i&&i.play()}},_atLastFrame:function(){return this._currentFrameIndex>=this._currentAnimation.frames.length-1},_step:function(){if(this._currentAnimation){var t=Math.min(this._getNextAnimationFrame(),this._currentAnimation.frames.length-1),i=!this._currentFrame||this._currentFrameIndex!==t;this._currentFrameIndex=t,this._atLastFrame()&&this._currentAnimation.useExitBranching||(this._currentFrame=this._currentAnimation.frames[this._currentFrameIndex]),this._draw(),this._playSound(),this._loop=window.setTimeout($.proxy(this._step,this),this._currentFrame.duration),this._endCallback&&i&&this._atLastFrame()&&(this._currentAnimation.useExitBranching&&!this._exiting?this._endCallback(this.currentAnimationName,clippy.Animator.States.WAITING):this._endCallback(this.currentAnimationName,clippy.Animator.States.EXITED))}},pause:function(){window.clearTimeout(this._loop)},resume:function(){this._step()}},clippy.Animator.States={WAITING:1,EXITED:0},clippy.Balloon=function(t){this._targetEl=t,this._hidden=!0,this._setup()},clippy.Balloon.prototype={WORD_SPEAK_TIME:200,CLOSE_BALLOON_DELAY:2e3,_setup:function(){this._balloon=$('<div class="clippy-balloon"><div class="clippy-tip"></div><div class="clippy-content"></div></div> ').hide(),this._content=this._balloon.find(".clippy-content"),$(document.body).append(this._balloon)},reposition:function(){for(var t=["top-left","top-right","bottom-left","bottom-right"],i=0;i<t.length;i++){var e=t[i];if(this._position(e),!this._isOut())break}},_BALLOON_MARGIN:15,_position:function(t){var i=this._targetEl.offset(),e=this._targetEl.height(),o=this._targetEl.width();i.top-=$(window).scrollTop(),i.left-=$(window).scrollLeft();var n=this._balloon.outerHeight(),s=this._balloon.outerWidth();this._balloon.removeClass("clippy-top-left"),this._balloon.removeClass("clippy-top-right"),this._balloon.removeClass("clippy-bottom-right"),this._balloon.removeClass("clippy-bottom-left");var a,h;switch(t){case"top-left":a=i.left+o-s,h=i.top-n-this._BALLOON_MARGIN;break;case"top-right":a=i.left,h=i.top-n-this._BALLOON_MARGIN;break;case"bottom-right":a=i.left,h=i.top+e+this._BALLOON_MARGIN;break;case"bottom-left":a=i.left+o-s,h=i.top+e+this._BALLOON_MARGIN}this._balloon.css({top:h,left:a}),this._balloon.addClass("clippy-"+t)},_isOut:function(){var t=this._balloon.offset(),i=this._balloon.outerHeight(),e=this._balloon.outerWidth(),o=$(window).width(),n=$(window).height(),s=$(document).scrollTop(),a=$(document).scrollLeft(),h=t.top-s,r=t.left-a,l=5;return 0>h-l||0>r-l?!0:h+i+l>n||r+e+l>o?!0:!1},speak:function(t,i,e){this._hidden=!1,this.show();var o=this._content;o.height("auto"),o.width("auto"),o.text(i),o.height(o.height()),o.width(o.width()),o.text(""),this.reposition(),this._complete=t,this._sayWords(i,[],e,t)},ask:function(t,i,e,o){choices=[];for(var n in e)d=$('<div class="clippy-choice"></div>').text(e[n]),choices.push(d);this._hidden=!1,this.show();var s=this._content;s.height("auto"),s.width("auto"),s.text(i);for(var n in choices)s.append(choices[n]);s.height(s.height()),s.width(s.width()),s.text(""),this.reposition(),this._complete=t,this._sayWords(i,choices,!0,t,o)},show:function(){this._hidden||this._balloon.show()},hide:function(){this._balloon.hide()},_sayWords:function(t,i,e,o,n){this._active=!0,this._hold=e;var s=t.split(/[^\S-]/),a=this.WORD_SPEAK_TIME,h=this._content,r=1;this._addWord=$.proxy(function(){if(this._active)if(r<=s.length)h.text(s.slice(0,r).join(" ")),r++,this._loop=window.setTimeout($.proxy(this._addWord,this),a);else{for(var t in i)h.append(i[t]);self=this,$(".clippy-choice").click(function(){self.close(!0),n&&n($(this).text())}),delete this._addWord,this._active=!1,this._hold||(o(),delete this._complete,this.close())}},this),this._addWord()},close:function(t){return this._active?void(this._hold=!1):(this._hold&&(this._hold=!1,this._complete&&(this._complete(),delete this._complete)),void(this._hidden||(t?(this._balloon.hide(),this._hidden=!0):this._hiding=window.setTimeout($.proxy(this._finishHideBalloon,this),this.CLOSE_BALLOON_DELAY))))},_finishHideBalloon:function(){this._active||(this._balloon.hide(),this._hidden=!0,this._hiding=null)},pause:function(){window.clearTimeout(this._loop),this._hiding&&(window.clearTimeout(this._hiding),this._hiding=null)},resume:function(){this._addWord?this._addWord():this._hold||this._hidden||(this._hiding=window.setTimeout($.proxy(this._finishHideBalloon,this),this.CLOSE_BALLOON_DELAY))}},clippy.BASE_PATH="agents/",clippy.load=function(t,i,e,o){o=o||clippy.BASE_PATH+t;var n,s=clippy.load._loadMap(o),a=clippy.load._loadAgent(t,o),h=clippy.load._loadSounds(t,o);a.done(function(t){n=t});var r;h.done(function(t){r=t});var l=function(){var t=new clippy.Agent(o,n,r);i(t)};$.when(s,a,h).done(l).fail(e)},clippy.load._maps={},clippy.load._loadMap=function(t){var i=clippy.load._maps[t];if(i)return i;i=clippy.load._maps[t]=$.Deferred();var e=t+"/map.png",o=new Image;return o.onload=i.resolve,o.onerror=i.reject,o.setAttribute("src",e),i.promise()},clippy.load._sounds={},clippy.load._loadSounds=function(t,i){var e=clippy.load._sounds[t];if(e)return e;e=clippy.load._sounds[t]=$.Deferred();var o=document.createElement("audio"),n=!!o.canPlayType&&""!=o.canPlayType("audio/mpeg"),s=!!o.canPlayType&&""!=o.canPlayType('audio/ogg; codecs="vorbis"');if(n||s){var a=i+(n?"/sounds-mp3.js":"/sounds-ogg.js");clippy.load._loadScript(a)}else e.resolve({});return e.promise()},clippy.load._data={},clippy.load._loadAgent=function(t,i){var e=clippy.load._data[t];if(e)return e;e=clippy.load._getAgentDfd(t);var o=i+"/agent.js";return clippy.load._loadScript(o),e.promise()},clippy.load._loadScript=function(t){var i=document.createElement("script");i.setAttribute("src",t),i.setAttribute("async","async"),i.setAttribute("type","text/javascript");var e=document.head||document.getElementsByTagName("head")[0];e.appendChild(i)},clippy.load._getAgentDfd=function(t){var i=clippy.load._data[t];return i||(i=clippy.load._data[t]=$.Deferred()),i},clippy.ready=function(t,i){var e=clippy.load._getAgentDfd(t);e.resolve(i)},clippy.soundsReady=function(t,i){var e=clippy.load._sounds[t];e||(e=clippy.load._sounds[t]=$.Deferred()),e.resolve(i)},clippy.Queue=function(t){this._queue=[],this._onEmptyCallback=t},clippy.Queue.prototype={queue:function(t){this._queue.push(t),this.next()},next:function(){if(!this._active){if(!this._queue.length)return void this._onEmptyCallback();var t=this._queue.shift();this._active=!0;var i=$.proxy(this._finish,this);t(i)}},_finish:function(){this._active=!1,this.next()},clear:function(){this._queue=[]}};